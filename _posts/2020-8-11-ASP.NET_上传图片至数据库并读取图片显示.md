---
layout:     post
title:      ASP.NET_上传图片至数据库并读取图片显示
subtitle:   
date:       2020-8-11
author:     Coderidea
header-style: text
catalog: true
tags:
- 程序人生
- 网站设计
- 企业架构
--- 
<div class="postBody">
			<div id="cnblogs_post_body" class="blogpost-body"><p><span class="Apple-style-span" style="color:#542d24;font-family:Arial;font-size:14px;line-height:20px;">今天，和大家讨论一下在ASP.NET中，如何上传图片至数据库，然后再将图片读取显示的问题。欢迎高手提出自己的方法！！！<br style="line-height:normal;" /><br style="line-height:normal;" />目前，我主要用到以下两种方法：<br style="line-height:normal;" /><br style="line-height:normal;" />1：上传图片的相对路径到数据库中相应字段里，读取显示时，将控件（假设用的是Image控件）的ImageUrl属性指向该相对路径即可。<br style="line-height:normal;" /><br style="line-height:normal;" />2：将图片以二进制流的方式整体上传到数据库里，读取显示时，以二进制流的方式整体读出。这种方法稍微麻烦一点，但保存的是图片整体到数据库里。<br style="line-height:normal;" /><br style="line-height:normal;" />第一种方法，实现起来比较简单，因为存入数据库里的只是图片相对路径，当然，同时也就有很大的局限性，由于是相对路径，所以当本地的图片变换了位置<br style="line-height:normal;" /><br style="line-height:normal;" />或移除，或是在其他主机上浏览该图片时，就无法显示了。第二种方法，就比较灵活了，可以用在交互性的页面，比如校友录，因为上传的是整张图片，所<br style="line-height:normal;" /><br style="line-height:normal;" />以只要读取正确，就能任何主机上显示出来。<br style="line-height:normal;" /><br style="line-height:normal;" />下面，分别通过实际的代码，介绍这两种方法。<br style="line-height:normal;" /><br style="line-height:normal;" />在这两个方法里，我将用到一个控件：FileUpload，该控件的具体用法参见百度谷歌。。。学习过程中，最好的老师就是他们俩。<br style="line-height:normal;" /><br style="line-height:normal;" />1：上传图片相对路径，并读取显示。<br style="line-height:normal;" /><br style="line-height:normal;" />数据库里的字段很简单，就两个<br style="line-height:normal;" />Image_ID    int    identity(1,1)     primarykey    not null<br style="line-height:normal;" />Image_Wpath    varchar(50)        null<br style="line-height:normal;" />Image_Wpath 用来保存图片的相对路径<br style="line-height:normal;" /><br style="line-height:normal;" />很简单的界面(其实是有点丑。。。。)：<br style="line-height:normal;" /><img title="点击图片可在新窗口打开" border="0" src="http://space.hackbase.com/attachments/2009/03/4996055_200903281957571xFyO.jpg" style="line-height:normal;" alt="4996055_200903281957571xFyO.jpg" /><br style="line-height:normal;" /><br style="line-height:normal;" />这里注意，我需要上传的文件都放在文件夹“Image”，在后面的上传路径里就需要这个文件夹。<br style="line-height:normal;" /><br style="line-height:normal;" />下面是效果图：<br style="line-height:normal;" /><img title="点击图片可在新窗口打开" border="0" src="http://space.hackbase.com/attachments/2009/03/4996055_200903281957572i5ui.jpg" style="line-height:normal;" alt="4996055_200903281957572i5ui.jpg" /><br style="line-height:normal;" /><br style="line-height:normal;" />我在输入框里填入Image_ID的值，读取指定的图片，在图片的下面，显示出该图片的相对路径。<br style="line-height:normal;" /><br style="line-height:normal;" />接下来，我们看一下具体代码实现上传和读取显示功能。<br style="line-height:normal;" /><br style="line-height:normal;" />在项目里，有一个sqlHelper类，是一些常用的数据访问方法。这里就不详细讲了。<br style="line-height:normal;" /><br style="line-height:normal;" />上传按钮里的事件:</span></p>
<p style="line-height:normal;font-weight:bold;margin-left:1em;">CODE:</p>
<p><span class="Apple-style-span" style="color:#542d24;font-family:Arial;font-size:14px;line-height:20px;"><code style="line-height:normal;margin-left:1em;font:normal normal normal 12px/1.8em Courier, monospace;border-width:1px;border-color:#cccccc;border-style:solid;">protected void Button1_Click(object sender, EventArgs e)<br style="line-height:normal;" />{<br style="line-height:normal;" />       string name = FileUpload1.FileName;       //获取文件名<br style="line-height:normal;" />       string type = name.Substring(name.LastIndexOf(".") + 1);    //获取文件类型<br style="line-height:normal;" />       string ipath = Server.MapPath("Image") + "\\" + name;    //获取文件路径<br style="line-height:normal;" />       string wpath = "Image\\" + name;        //[color=red]设置文件保存相对路径(这里的路径起始就是我们存放图片的文件夹名)[/color]<br style="line-height:normal;" /><br style="line-height:normal;" />       string query1 = "insert into Images values('" + wpath + "')";<br style="line-height:normal;" /><br style="line-height:normal;" />       if (type == "jpg" || type == "gif" || type == "bmp" || type == "png")<br style="line-height:normal;" />       {<br style="line-height:normal;" />         FileUpload1.SaveAs(ipath);        //服务器保存路径<br style="line-height:normal;" />         sqlHelper.ExecterNonQuery(query1);<br style="line-height:normal;" />       }<br style="line-height:normal;" />}</code>显示按钮事件：</span></p>
<p style="line-height:normal;font-weight:bold;margin-left:1em;">CODE:</p>
<p><span class="Apple-style-span" style="color:#542d24;font-family:Arial;font-size:14px;line-height:20px;"><code style="line-height:normal;margin-left:1em;font:normal normal normal 12px/1.8em Courier, monospace;border-width:1px;border-color:#cccccc;border-style:solid;">protected void Button2_Click(object sender, EventArgs e)<br style="line-height:normal;" />{<br style="line-height:normal;" />       string query2 = "select * from Images where Image_ID=" + Convert.ToInt32(TextBox1.Text);<br style="line-height:normal;" />       SqlDataReader sdr = sqlHelper.GetReader(query2);<br style="line-height:normal;" />       string wpath2 = "";<br style="line-height:normal;" />       while (sdr.Read())<br style="line-height:normal;" />       {<br style="line-height:normal;" />         wpath2 = sdr[1].ToString();    //获得相对路径<br style="line-height:normal;" />       }<br style="line-height:normal;" />       sdr.Close();<br style="line-height:normal;" />       Image1.ImageUrl = wpath2;    //图片显示路径就是相对路径<br style="line-height:normal;" />       Label1.Text = wpath2;    //显示相对路径<br style="line-height:normal;" />}</code>2:以二进制流的方式存入数据库，并读取显示。<br style="line-height:normal;" /><br style="line-height:normal;" />数据库的字段同样简单：<br style="line-height:normal;" />Image_ID    int    identity(1,1)     primarykey    not null<br style="line-height:normal;" />Image_Content     image null<br style="line-height:normal;" />Image_Content以二进制形式保存图片<br style="line-height:normal;" /><br style="line-height:normal;" />整体看一下例子里的页面组成：<br style="line-height:normal;" /><img title="点击图片可在新窗口打开" border="0" src="http://space.hackbase.com/attachments/2009/03/4996055_200903282102492c2cQ.jpg" style="line-height:normal;" alt="4996055_200903282102492c2cQ.jpg" /><br style="line-height:normal;" /><br style="line-height:normal;" />上传图片页面和第一种方法一样，同样是用到FileUpload，以及一个Button，具体代码如下：</span></p>
<p style="line-height:normal;font-weight:bold;margin-left:1em;">CODE:</p>
<p><span class="Apple-style-span" style="color:#542d24;font-family:Arial;font-size:14px;line-height:20px;"><code style="line-height:normal;margin-left:1em;font:normal normal normal 12px/1.8em Courier, monospace;border-width:1px;border-color:#cccccc;border-style:solid;">protected void Button1_Click(object sender, EventArgs e)<br style="line-height:normal;" />{<br style="line-height:normal;" />       string name = FileUpload1.PostedFile.FileName;<br style="line-height:normal;" />       string type = name.Substring(name.LastIndexOf(".") + 1); <br style="line-height:normal;" />       FileStream fs = File.OpenRead(name);<br style="line-height:normal;" />       byte[] content = new byte[fs.Length];<br style="line-height:normal;" />       fs.Read(content, 0, content.Length);<br style="line-height:normal;" />       fs.Close();<br style="line-height:normal;" /><br style="line-height:normal;" />       SqlConnection conn = new SqlConnection("Data Source=;Initial Catalog=;Persist Security Info=True;User ID=;Pooling=False;Password=");<br style="line-height:normal;" />       SqlCommand cmd = conn.CreateCommand();<br style="line-height:normal;" />       conn.Open();<br style="line-height:normal;" />       cmd.CommandText = "insert into Images(Image_Content) values (@content)";<br style="line-height:normal;" />       cmd.CommandType = CommandType.Text;<br style="line-height:normal;" /><br style="line-height:normal;" />       if (type == "jpg" || type == "gif" || type == "bmp" || type == "png")<br style="line-height:normal;" />       {<br style="line-height:normal;" />         SqlParameter para = cmd.Parameters.Add("@content", SqlDbType.Image);<br style="line-height:normal;" />         para.Value = content;<br style="line-height:normal;" />         cmd.ExecuteNonQuery();<br style="line-height:normal;" />       }<br style="line-height:normal;" />}</code>显示一张图片和显示一组图片有所不同，将会分别说明之。<br style="line-height:normal;" /><br style="line-height:normal;" />显示一张图片，要用到Default.aspx和Default2.aspx。Default.aspx中有一个控件Image，它的属性ImageUrl指向Default2.aspx用于显示图片。Default2.aspx用于<br style="line-height:normal;" /><br style="line-height:normal;" />读取图片。<br style="line-height:normal;" /><br style="line-height:normal;" /><img title="点击图片可在新窗口打开" border="0" src="http://space.hackbase.com/attachments/2009/03/4996055_200903282102491LEwp.jpg" style="line-height:normal;" alt="4996055_200903282102491LEwp.jpg" /><br style="line-height:normal;" /><br style="line-height:normal;" />Default.aspx.cs</span></p>
<p style="line-height:normal;font-weight:bold;margin-left:1em;">CODE:</p>
<p><span class="Apple-style-span" style="color:#542d24;font-family:Arial;font-size:14px;line-height:20px;"><code style="line-height:normal;margin-left:1em;font:normal normal normal 12px/1.8em Courier, monospace;border-width:1px;border-color:#cccccc;border-style:solid;">protected void Page_Load(object sender, EventArgs e)<br style="line-height:normal;" />{<br style="line-height:normal;" /><br style="line-height:normal;" />       Image1.ImageUrl = "Default2.aspx";<br style="line-height:normal;" />}</code>Default2.aspx.cs</span></p>
<p style="line-height:normal;font-weight:bold;margin-left:1em;">CODE:</p>
<p><span class="Apple-style-span" style="color:#542d24;font-family:Arial;font-size:14px;line-height:20px;"><code style="line-height:normal;margin-left:1em;font:normal normal normal 12px/1.8em Courier, monospace;border-width:1px;border-color:#cccccc;border-style:solid;">       string imgid = Request.QueryString["imgid"];<br style="line-height:normal;" />       SqlConnection conn1 = new SqlConnection("Data Source=;Initial Catalog=;Persist Security Info=True;User ID=sa;Pooling=False;Password=");<br style="line-height:normal;" />       SqlCommand cmd1 = new SqlCommand("select Image_Content from Images where Image_ID=3", conn1);     //固定显示Image_ID为3的图片<br style="line-height:normal;" />       conn1.Open();<br style="line-height:normal;" />       SqlDataReader sdr = cmd1.ExecuteReader();<br style="line-height:normal;" />       if (sdr.Read())<br style="line-height:normal;" />       {<br style="line-height:normal;" />         Response.BinaryWrite((byte[])sdr["Image_Content"]);<br style="line-height:normal;" />       }<br style="line-height:normal;" />       Response.End();</code>显示一组图片时，用ashx Handle存放图片。同时用GridView以列显示图片。Image控件绑定Image_ID。<br style="line-height:normal;" /><br style="line-height:normal;" /><img title="点击图片可在新窗口打开" border="0" src="http://space.hackbase.com/attachments/2009/03/4996055_200903282102493xcAM.jpg" style="line-height:normal;" alt="4996055_200903282102493xcAM.jpg" /><br style="line-height:normal;" /><br style="line-height:normal;" />allimage.aspx</span></p>
<p style="line-height:normal;font-weight:bold;margin-left:1em;">CODE:</p>
<p><span class="Apple-style-span" style="color:#542d24;font-family:Arial;font-size:14px;line-height:20px;"><code style="line-height:normal;margin-left:1em;font:normal normal normal 12px/1.8em Courier, monospace;border-width:1px;border-color:#cccccc;border-style:solid;">&lt;%@ Page Language="C#" AutoEventWireup="true" CodeFile="allimage.aspx.cs" Inherits="allimage" %&gt;<br style="line-height:normal;" /><br style="line-height:normal;" />&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"&gt;<br style="line-height:normal;" /><br style="line-height:normal;" />&lt;HTML xmlns="http://www.w3.org/1999/xhtml"&gt; <br style="line-height:normal;" />&lt;HEAD runat="server"&gt; <br style="line-height:normal;" />&lt;title&gt;BindImg&lt;/title&gt; <br style="line-height:normal;" />&lt;/HEAD&gt; <br style="line-height:normal;" />&lt;body&gt; <br style="line-height:normal;" />&lt;form id="Form1" method="post" runat="server"&gt; <br style="line-height:normal;" />&lt;FONT face="宋体"&gt; <br style="line-height:normal;" />&lt;asp:DataGrid id="MyDataGrid" runat="server" AutoGenerateColumns="False" Width="632px"&gt; <br style="line-height:normal;" />&lt;AlternatingItemStyle BackColor="Beige"&gt;&lt;/AlternatingItemStyle&gt; <br style="line-height:normal;" />&lt;HeaderStyle HorizontalAlign="Center"&gt;&lt;/HeaderStyle&gt; <br style="line-height:normal;" />&lt;Columns&gt; <br style="line-height:normal;" />&lt;asp:TemplateColumn HeaderText="Photo"&gt; <br style="line-height:normal;" />&lt;ItemTemplate&gt; &lt;asp:Image ID="Image1" runat="server" Height="70px" ImageUrl='&lt;%# "Getimg.ashx?id="+Eval("Image_ID") %&gt;'<br style="line-height:normal;" />       Width="100px" /&gt;<br style="line-height:normal;" />&lt;/ItemTemplate&gt; <br style="line-height:normal;" />&lt;/asp:TemplateColumn&gt; <br style="line-height:normal;" />&lt;/Columns&gt; <br style="line-height:normal;" />&lt;/asp:DataGrid&gt;&lt;/FONT&gt; <br style="line-height:normal;" />&lt;asp:SqlDataSource ID="SqlDataSource1" runat="server" ConnectionString="&lt;%$ ConnectionStrings:PracticeConnectionString %&gt;"<br style="line-height:normal;" />       SelectCommand="SELECT * FROM [Images]"&gt;&lt;/asp:SqlDataSource&gt;<br style="line-height:normal;" />&lt;/form&gt; <br style="line-height:normal;" />&lt;/body&gt; <br style="line-height:normal;" />&lt;/HTML&gt;</code>allimage.aspx.cs</span></p>
<p style="line-height:normal;font-weight:bold;margin-left:1em;">CODE:</p>
<p><span class="Apple-style-span" style="color:#542d24;font-family:Arial;font-size:14px;line-height:20px;"><code style="line-height:normal;margin-left:1em;font:normal normal normal 12px/1.8em Courier, monospace;border-width:1px;border-color:#cccccc;border-style:solid;">protected void Page_Load(object sender, EventArgs e)<br style="line-height:normal;" />{<br style="line-height:normal;" />       MyDataGrid.DataSource = SqlDataSource1;<br style="line-height:normal;" />       MyDataGrid.DataBind();<br style="line-height:normal;" />}</code>Getimg.ashx</span></p>
<p style="line-height:normal;font-weight:bold;margin-left:1em;">CODE:</p>
<p style="line-height:normal;"><code style="line-height:normal;margin-left:1em;font:normal normal normal 12px/1.8em Courier, monospace;border-width:1px;border-color:#cccccc;border-style:solid;">&lt;%@ WebHandler Language="C#" Class="Getimg" %&gt;<br style="line-height:normal;" /><br style="line-height:normal;" />using System;<br style="line-height:normal;" />using System.Web;<br style="line-height:normal;" />using System.Data;<br style="line-height:normal;" />using System.Data.SqlClient;<br style="line-height:normal;" />using System.Configuration;<br style="line-height:normal;" /><br style="line-height:normal;" />public class Getimg : IHttpHandler {<br style="line-height:normal;" /><br style="line-height:normal;" />public void ProcessRequest (HttpContext context)<br style="line-height:normal;" />{<br style="line-height:normal;" />       int id = int.Parse(context.Request.QueryString["id"]);<br style="line-height:normal;" />       SqlConnection conn = new SqlConnection(@"server=;database=;uid=;pwd=");<br style="line-height:normal;" />       SqlCommand cmd = new SqlCommand("select Image_Content from Images where Image_ID='" + id + "'", conn);<br style="line-height:normal;" />       cmd.Parameters.Add("@id", SqlDbType.Int).Value = id;<br style="line-height:normal;" />       conn.Open();<br style="line-height:normal;" />       SqlDataReader dr = cmd.ExecuteReader();<br style="line-height:normal;" />       if (dr.Read())<br style="line-height:normal;" />       {<br style="line-height:normal;" />         context.Response.BinaryWrite((byte[])dr["Image_Content"]); <br style="line-height:normal;" />       }<br style="line-height:normal;" />       dr.Close();<br style="line-height:normal;" />}<br style="line-height:normal;" /><br style="line-height:normal;" />public bool IsReusable {<br style="line-height:normal;" />       get {<br style="line-height:normal;" />         return false;<br style="line-height:normal;" />       }<br style="line-height:normal;" />}<br style="line-height:normal;" /><br style="line-height:normal;" />}</code>总结：<br style="line-height:normal;" />两种图片上传及读取显示方法，各有优点，个人更倾向于用第二种。因为第二种方法达到了真正的将图片上传到数据库。在某些项目中，我们也可能要用到第一种方法。本例中，没有严格的判断图片上传的格式，学习的朋友可以自己做严格判断，防止上传的是有害文件。如果您也好的上传图片及显示图片的方法，不妨跟帖讨论，谢谢。</p></div><div id="MySignature"></div>
<div class="clear"></div>
<div id="blog_post_info_block">
<div id="BlogPostCategory"></div>
<div id="EntryTag"></div>
<div id="blog_post_info">
</div>
<div class="clear"></div>
<div id="post_next_prev"></div>
</div>


		</div>